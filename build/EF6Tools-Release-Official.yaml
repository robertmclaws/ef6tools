trigger: none
pr: none
name: $(Date:yyyyMMdd).$(Rev:r)

parameters:
- name: InsertionTargetBranch
  type: string
  default: main

variables:
- name: InsertReviewers
  value: .NET Developer Experience WLP;Razor - Web - Hot Reload
- name: InsertRevisionFiles
  value: src/SetupPackages/EntityFramework/EntityFrameworkTools/revision.txt;src/SetupPackages/EntityFramework/EntityFrameworkToolsMsi/revision.txt
- name: InsertTargetBranch
  value: main
- name: InsertTeamEmail
  value: dotnetdevexwlp@microsoft.com
- name: InsertTeamName
  value: EF6Tools
- name: SymbolsFeatureName
  value: EF6Tools
- name: SymbolsProject
  value: VS
- name: SymbolsAgentPath
  value: $(System.DefaultWorkingDirectory)\_dotnet.ef6tools-VS2019\Symbols
- name: TeamName
  value: EF6Tools
resources:
  pipelines:
  - pipeline: '_dotnetef6tools-VS2019'
    project: 'DevDiv'
    source: 'EntityFramework\dotnet.ef6tools-VS2019'
repositories:
  - repository: 1ESPipelineTemplates
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/release
extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    pool:
      name: VSEngSS-MicroBuild2022-1ES
      os: windows
    stages:
    - stage: Stage_1
      displayName: VS Insertion
      jobs:
      - job: Job_1
        displayName: Agent job
        condition: succeeded()
        timeoutInMinutes: 0
        templateContext:
          inputs:
          - input: pipelineArtifact
            pipeline: '_dotnetef6tools-VS2019'
            artifactName: 'SetupResults'
            targetPath: '$(Pipeline.Workspace)/SetupResults'
          - input: pipelineArtifact
            pipeline: '_dotnetef6tools-VS2019'
            artifactName: 'PdbsAndXmls'
            targetPath: '$(SymbolsAgentPath)'
          - input: pipelineArtifact
            pipeline: '_dotnetef6tools-VS2019'
            artifactName: 'BinDirContents'
            targetPath: '$(Pipeline.Workspace)/BinDirContents'
        steps:
        - checkout:none
        - task: PowerShell@2
          displayName: Load Insertion Variables
          inputs:
            targetType: inline
            script: Get-Content $(Pipeline.Workspace)\BinDirContents\bin\Release\InsertionParameters.txt
        - task: PowerShell@2
          displayName: Print Out Task Variables
          inputs:
            targetType: inline
            script: |-
              Write-Host "InsertAccessToken: $env:InsertAccessToken"
              Write-Host "InsertAutoComplete: $env:InsertAutoComplete"
              Write-Host "InsertBuildPolicy: $env:InsertBuildPolicy"
              Write-Host "InsertConfigValues: $env:InsertConfigValues"
              Write-Host "InsertCustomScriptExecutionCommand: $env:InsertCustomScriptExecutionCommand"
              Write-Host "InsertDescription: $env:InsertDescription"
              Write-Host "InsertJsonValues: $env:InsertJsonValues"
              Write-Host "InsertPayloadName: $env:InsertPayloadName"
              Write-Host "InsertReviewers: $env:InsertReviewers"
              Write-Host "InsertRevisionFiles: $env:InsertRevisionFiles"
              Write-Host "InsertTargetBranch: $env:InsertTargetBranch"
              Write-Host "InsertTeamEmail: $env:InsertTeamEmail"
              Write-Host "InsertTeamName: $env:InsertTeamName"
              Write-Host "InsertTopicBranch: $env:InsertTopicBranch"
              Write-Host "InsertVersionsValues: $env:InsertVersionsValues"
              Write-Host "InsertWaitMinutes: $env:InsertWaitMinutes"
              Write-Host "SymbolsAgentPath: $env:SymbolsAgentPath"
              Write-Host "SymbolsEmailContacts: $env:SymbolsEmailContacts"
              Write-Host "SymbolsFeatureName: $env:SymbolsFeatureName"
              Write-Host "SymbolsSymwebProject: $env:SymbolsSymwebProject"
              Write-Host "SymbolsUncPath: $env:SymbolsUncPath"
              Write-Host "VstsDropNames: $env:VstsDropNames"
              Write-Host "Build_Reason: $env:Build_Reason"
              Write-Host "BuildVersion: $env:BuildVersion"
        - task: NuGetCommand@2
          displayName: NuGet pack
          inputs:
            command: pack
            searchPatternPack: $(Pipeline.Workspace)\BinDirContents\bin\Release\EFTools15.nuspec
            basePath: $(Pipeline.Workspace)\BinDirContents\bin\Release\
        - task: 1ES.PublishNuGet@1
          displayName: 'NuGet push (VS-CoreXtFeeds)'
          inputs:
            packageParentPath: '$(Build.ArtifactStagingDirectory)'
            feedPublish: 37a181e8-5ec9-4e8d-a499-07b754f9b4f8
            allowPackageConflicts: true
        - task: 1ES.PublishNuGet@1
          displayName: 'NuGet push (VS-TestCoreXtFeeds)'
          inputs:
            packageParentPath: '$(Build.ArtifactStagingDirectory)'
            feedRestore: 5a41f7e2-6ea1-44eb-b994-f77d0ac0aefb
            feedPublish: 5a41f7e2-6ea1-44eb-b994-f77d0ac0aefb
            allowPackageConflicts: true
        - task: MicroBuildArchiveSymbols@6    
          displayName: 'Upload Symbols to Symweb/MSDL'
          inputs:
            azureSubscription: 'VSEng-SymbolsUpload'
            SymbolsFeatureName: $(SymbolsFeatureName)
            SymbolsProject: $(SymbolsProject)
            SymbolsAgentPath: $(SymbolsAgentPath)
          env:
            SYSTEM_ACCESSTOKEN: $(System.AccessToken)
        - task: MicroBuildRetainVstsDrops@1
          displayName: Retain Azure DevOps Drops
          inputs:
            DropRetentionDays: 1825
        - task: MicroBuildInsertVsPayload@5
          displayName: Insert VS Payload
          inputs:
            DefaultConfigValues: VS.Redist.Common.WPT.EFTOOLS15=$(BuildVersion)
            PackagePropsValues: VS.Redist.Common.WPT.EFTools15=$(BuildVersion)
            AllowTopicBranchUpdate: true
            InsertionBuildPolicies: Request Perf DDRITs
            AutoCompletePR: true
            AutoCompleteMergeStrategy: Squash